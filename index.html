<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ Ùˆ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <style>
        :root { --primary-color: #2c3e50; --accent-color: #27ae60; --gray-bg: #f2f2f2; }
        body { font-family: Tahoma, Geneva, sans-serif; background-color: #fafafa; padding: 20px; font-size: 13px; }
        .container { max-width: 1250px; margin: auto; background: white; padding: 25px; border: 1px solid #ccc; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #000; padding-bottom: 15px; }
        .header-item { display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .top-header input { border: none; border-bottom: 1px dotted #000; padding: 3px; width: 130px; outline: none; background: transparent; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        th { background-color: #000; color: white; padding: 10px; border: 1px solid #444; font-weight: normal; }
        td { border: 1px solid #000; padding: 6px; text-align: center; height: 35px; word-wrap: break-word; }
        tr:nth-child(even) { background-color: var(--gray-bg); }
        
        .status-cell { cursor: pointer; font-size: 18px; user-select: none; width: 45px; }
        .status-check { color: #27ae60; }
        .status-cross { color: #e74c3c; }

        .actions { margin-bottom: 15px; display: flex; gap: 10px; }
        .btn { padding: 8px 18px; border: none; border-radius: 4px; cursor: pointer; color: white; font-family: Tahoma; font-weight: bold; }
        .btn-new { background-color: var(--accent-color); }
        .btn-clear { background-color: #e74c3c; }
        .btn-share { background-color: #2980b9; margin-top: 15px; width: 100%; }

        .summary-report { margin-top: 40px; padding: 20px; border: 2px solid #333; background-color: #fff; width: fit-content; min-width: 250px; border-radius: 8px; }
        .summary-report h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 15px; text-align: center; }
        
        .report-field { display: flex; align-items: center; margin-bottom: 10px; }
        .report-field label { font-weight: bold; width: 110px; display: flex; justify-content: space-between; }
        .report-field input { width: 70px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; margin-right: 10px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: white; margin: 5% auto; padding: 25px; border-radius: 8px; width: 400px; }
        .form-group { margin-bottom: 12px; display: flex; flex-direction: column; }
        .form-group input, .form-group select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: Tahoma; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ ØªÙ‚ÙˆÛŒÙ… Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø¨Ø§ Ø¸Ø§Ù‡Ø± Ø´Ù…Ø§ */
        .datepicker-plot-area { font-family: Tahoma !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-header">
        <div class="header-item">Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÛŒÙ…ÛŒ: <input type="text" id="ownerName"></div>
        <div class="header-item">Ø±ÙˆØ²: <input type="text" id="dayName" readonly style="border-bottom:none; color:#555;"></div>
        <div class="header-item">Ù…ÙˆØ±Ø®Ù‡: <input type="text" id="todayDate" class="pdate" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®..."></div>
        <div class="header-item">ØªÙˆØ¶ÛŒØ­Ø§Øª: <input type="text" id="extraNote" style="width: 200px;"></div>
    </div>

    <div class="actions">
        <button class="btn btn-new" onclick="openModal()">+ Ø«Ø¨Øª ÙØ¹Ø§Ù„ÛŒØª Ø¬Ø¯ÛŒØ¯</button>
        <button class="btn btn-clear" onclick="clearAllDataForToday()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù…Ø±ÙˆØ²</button>
    </div>

    <table id="mainTable">
        <thead>
            <tr>
                <th style="width: 45px;">Ø±Ø¯ÛŒÙ</th>
                <th style="width: 50px;">Ù†ØªÛŒØ¬Ù‡</th>
                <th>Ø¹Ù†ÙˆØ§Ù† Ø¬Ù„Ø³Ù‡</th>
                <th>Ù…Ø®Ø§Ø·Ø¨ Ø¬Ù„Ø³Ù‡</th>
                <th>Ù…Ø¹Ø±Ù</th>
                <th style="width: 75px;">Ø³Ø§Ø¹Øª</th>
                <th>Ù…Ú©Ø§Ù†</th>
                <th>Ø¨Ø±Ú¯Ø²Ø§Ø±Ú©Ù†Ù†Ø¯Ù‡</th>
                <th>Ù†ÙØ± Ú†Ù‡Ø§Ø±Ù…</th>
                <th style="width: 60px;">ÙˆÛŒØ±Ø§ÛŒØ´</th>
                <th style="width: 60px;">Ø­Ø°Ù</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div class="summary-report">
        <h3 id="summaryTitle">Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø± Ø±ÙˆØ²Ø§Ù†Ù‡</h3>
        <div class="report-field"><label>ØªØ¹Ø¯Ø§Ø¯ Ù…Ø´Ø§ÙˆØ±<span>:</span></label><input type="number" inputmode="numeric" id="stat_advisor"></div>
        <div class="report-field"><label>Ø²Ù†Ú¯ Ø¯Ø¹ÙˆØª<span>:</span></label><input type="number" inputmode="numeric" id="stat_invite"></div>
        <div class="report-field"><label>Ù¾Ø±Ø²Ù†Øª<span>:</span></label><input type="number" inputmode="numeric" id="stat_present"></div>
        <div class="report-field"><label>Ø§Ø±ØªØ¨Ø§Ø· Ù…Ø¤Ø«Ø±<span>:</span></label><input type="number" inputmode="numeric" id="stat_relation"></div>
        <div class="report-field"><label>Ø¢Ù…ÙˆØ²Ø´<span>:</span></label><input type="number" inputmode="numeric" id="stat_edu"></div>
        <div class="report-field"><label>Ø«Ø¨Øª Ù†Ø§Ù…<span>:</span></label><input type="number" inputmode="numeric" id="stat_reg"></div>
        <div class="report-field"><label>Ø§Ù…ØªÛŒØ§Ø² Ø®Ø±ÛŒØ¯<span>:</span></label><input type="number" inputmode="numeric" id="stat_point"></div>
        
        <button class="btn btn-share" onclick="shareReport()">ğŸ“¤ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ú¯Ø²Ø§Ø±Ø´</button>
    </div>
</div>

<div id="planModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Ø«Ø¨Øª ÙØ¹Ø§Ù„ÛŒØª</h3>
        <input type="hidden" id="editIndex" value="-1">
        <div class="form-group"><label>Ù†ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡:</label><select id="planType" onchange="toggleFields()"><option value="work">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ú©Ø§Ø±ÛŒ</option><option value="personal">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø´Ø®ØµÛŒ</option></select></div>
        <div class="form-group"><label>Ø¹Ù†ÙˆØ§Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡:</label><input type="text" id="title"></div>
        <div id="workFields">
            <div class="form-group"><label>Ù…Ø®Ø§Ø·Ø¨ Ø¬Ù„Ø³Ù‡:</label><input type="text" id="audience"></div>
            <div class="form-group"><label>Ù…Ø¹Ø±Ù:</label><input type="text" id="ref"></div>
            <div class="form-group"><label>Ù…Ú©Ø§Ù†:</label><input type="text" id="location"></div>
            <div class="form-group"><label>Ø¨Ø±Ú¯Ø²Ø§Ø±Ú©Ù†Ù†Ø¯Ù‡:</label><input type="text" id="organizer"></div>
            <div class="form-group"><label>Ù†ÙØ± Ú†Ù‡Ø§Ø±Ù…:</label><input type="text" id="fourthPerson"></div>
        </div>
        <div class="form-group"><label>Ø³Ø§Ø¹Øª:</label><input type="time" id="time"></div>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button class="btn" style="background-color: #95a5a6;" onclick="closeModal()">Ø§Ù†ØµØ±Ø§Ù</button>
            <button class="btn btn-new" onclick="saveEntry()">ØªØ§ÛŒÛŒØ¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
    </div>
</div>

<script>
    let currentKey = ""; 
    let longPressTimer;

    $(document).ready(function() {
        // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ
        $(".pdate").persianDatepicker({
            format: 'YYYY/MM/DD',
            autoClose: true,
            initialValue: true,
            onSelect: function(unix) {
                const dateObj = new persianDate(unix);
                const dateStr = dateObj.format('YYYY/MM/DD');
                const dayStr = dateObj.format('dddd');
                document.getElementById('dayName').value = dayStr;
                currentKey = dateStr;
                loadDataForDate(currentKey);
            }
        });

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        const today = new persianDate();
        currentKey = today.format('YYYY/MM/DD');
        document.getElementById('dayName').value = today.format('dddd');
        loadDataForDate(currentKey);

        // Ø°Ø®ÛŒØ±Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø¯Ø± Ùˆ Ø¢Ù…Ø§Ø± Ù…ÙˆÙ‚Ø¹ ØªØ§ÛŒÙ¾
        $('input').on('input', function() { saveAllToStorage(); });
    });

    function loadDataForDate(dateKey) {
        const fullData = JSON.parse(localStorage.getItem('teamPlanner_' + dateKey)) || {
            owner: localStorage.getItem('lastOwner') || "",
            note: "",
            stats: {},
            plans: []
        };

        document.getElementById('ownerName').value = fullData.owner;
        document.getElementById('extraNote').value = fullData.note || "";
        
        const s = fullData.stats;
        document.getElementById('stat_advisor').value = s.advisor || "";
        document.getElementById('stat_invite').value = s.invite || "";
        document.getElementById('stat_present').value = s.present || "";
        document.getElementById('stat_relation').value = s.relation || "";
        document.getElementById('stat_edu').value = s.edu || "";
        document.getElementById('stat_reg').value = s.reg || "";
        document.getElementById('stat_point').value = s.point || "";

        renderTable(fullData.plans);
        document.getElementById('summaryTitle').innerText = `Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø± Ø±ÙˆØ² ${document.getElementById('dayName').value} Ù…ÙˆØ±Ø®Ù‡ ${dateKey}`;
    }

    function saveAllToStorage() {
        const data = {
            owner: document.getElementById('ownerName').value,
            note: document.getElementById('extraNote').value,
            stats: {
                advisor: document.getElementById('stat_advisor').value,
                invite: document.getElementById('stat_invite').value,
                present: document.getElementById('stat_present').value,
                relation: document.getElementById('stat_relation').value,
                edu: document.getElementById('stat_edu').value,
                reg: document.getElementById('stat_reg').value,
                point: document.getElementById('stat_point').value
            },
            plans: getTableData()
        };
        localStorage.setItem('teamPlanner_' + currentKey, JSON.stringify(data));
        localStorage.setItem('lastOwner', data.owner); // Ø¨Ø±Ø§ÛŒ Ø­ÙØ¸ Ù†Ø§Ù… Ù…Ø¯ÛŒØ± Ø¯Ø± Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¨Ø¹Ø¯
    }

    function getTableData() {
        // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ù„ÛŒØ³Øª Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² Ù†Ø³Ø®Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ ÛŒØ§ Ø§Ø² Ø±Ù†Ø¯Ø±Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
        const d = JSON.parse(localStorage.getItem('teamPlanner_' + currentKey));
        return d ? d.plans : [];
    }

    function renderTable(plans) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        plans.forEach((item, index) => {
            const isPers = item.type === 'personal';
            const bg = isPers ? 'background-color: #333; color: #333;' : '';
            let icon = item.status === 'check' ? 'âœ”' : (item.status === 'cross' ? 'âœ–' : '');
            let cls = item.status === 'check' ? 'status-check' : 'status-cross';
            
            tbody.innerHTML += `<tr>
                <td>${index + 1}</td>
                <td class="status-cell ${cls}" onclick="handleStatusClick(${index})" onmousedown="startLP(${index})" onmouseup="cancelLP()" ontouchstart="startLP(${index})" ontouchend="cancelLP()">${icon}</td>
                <td>${item.title}</td>
                <td style="${bg}">${item.audience}</td>
                <td style="${bg}">${item.ref}</td>
                <td>${item.time}</td>
                <td style="${bg}">${item.location}</td>
                <td style="${bg}">${item.organizer}</td>
                <td style="${bg}">${item.fourthPerson}</td>
                <td><button class="btn btn-edit" style="background:#f39c12; padding:4px 8px; font-size:11px;" onclick="openModal(${index})">Ø§ØµÙ„Ø§Ø­</button></td>
                <td><button class="btn btn-delete" style="background:#e74c3c; padding:4px 8px; font-size:11px;" onclick="deleteRow(${index})">Ø­Ø°Ù</button></td>
            </tr>`;
        });
    }

    // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Modal Ùˆ Status (Ù…Ø´Ø§Ø¨Ù‡ Ù‚Ø¨Ù„ Ø¨Ø§ ØªØºÛŒÛŒØ± Ø¯Ø± Ù†Ø­ÙˆÙ‡ Ø°Ø®ÛŒØ±Ù‡)
    function openModal(idx = -1) { 
        document.getElementById('planModal').style.display = "block"; 
        if (idx > -1) {
            const d = getTableData()[idx];
            document.getElementById('editIndex').value = idx;
            document.getElementById('title').value = d.title;
            document.getElementById('audience').value = d.audience;
            document.getElementById('ref').value = d.ref;
            document.getElementById('time').value = d.time;
            document.getElementById('location').value = d.location;
            document.getElementById('organizer').value = d.organizer;
            document.getElementById('fourthPerson').value = d.fourthPerson;
            document.getElementById('planType').value = d.type;
        } else { resetForm(); }
        toggleFields();
    }

    function closeModal() { document.getElementById('planModal').style.display = "none"; }

    function saveEntry() {
        const idx = parseInt(document.getElementById('editIndex').value);
        const plans = getTableData();
        const row = {
            title: document.getElementById('title').value,
            audience: document.getElementById('audience').value,
            ref: document.getElementById('ref').value,
            time: document.getElementById('time').value,
            location: document.getElementById('location').value,
            organizer: document.getElementById('organizer').value,
            fourthPerson: document.getElementById('fourthPerson').value,
            type: document.getElementById('planType').value,
            status: idx > -1 ? (plans[idx].status || "") : ""
        };
        if (!row.title || !row.time) return;
        if (idx > -1) plans[idx] = row; else plans.push(row);
        plans.sort((a, b) => a.time.localeCompare(b.time));
        
        // Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
        const full = JSON.parse(localStorage.getItem('teamPlanner_' + currentKey));
        full.plans = plans;
        localStorage.setItem('teamPlanner_' + currentKey, JSON.stringify(full));
        
        renderTable(plans); closeModal();
    }

    function deleteRow(idx) {
        if(confirm("Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) {
            const full = JSON.parse(localStorage.getItem('teamPlanner_' + currentKey));
            full.plans.splice(idx, 1);
            localStorage.setItem('teamPlanner_' + currentKey, JSON.stringify(full));
            renderTable(full.plans);
        }
    }

    function updateStatus(idx, t) {
        const full = JSON.parse(localStorage.getItem('teamPlanner_' + currentKey));
        full.plans[idx].status = (full.plans[idx].status === t) ? "" : t;
        localStorage.setItem('teamPlanner_' + currentKey, JSON.stringify(full));
        renderTable(full.plans);
    }

    function handleStatusClick(idx) { if (longPressTimer !== null) updateStatus(idx, 'check'); }
    function startLP(idx) { longPressTimer = setTimeout(() => { updateStatus(idx, 'cross'); longPressTimer = null; }, 600); }
    function cancelLP() { clearTimeout(longPressTimer); }

    function resetForm() {
        document.getElementById('editIndex').value = "-1";
        document.querySelectorAll('#planModal input').forEach(i => i.value = "");
        document.getElementById('planType').value = "work";
    }

    function toggleFields() {
        const isP = document.getElementById('planType').value === 'personal';
        document.querySelectorAll('#workFields input').forEach(i => {
            i.disabled = isP;
            if(isP) { i.value = "---"; i.style.background = "#333"; }
            else { if(i.value === "---") i.value = ""; i.style.background = "#fff"; }
        });
    }

    function shareReport() {
        const getV = (id) => document.getElementById(id).value || "-";
        const text = `Ø³Ù„Ø§Ù… Ùˆ Ø®Ø¯Ø§ Ù‚ÙˆØª ğŸŒº\n\nÚ¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø±\n\n${document.getElementById('dayName').value} ${currentKey}\n\nØªØ¹Ø¯Ø§Ø¯ Ù…Ø´Ø§ÙˆØ±Ø§Ù†: ${getV('stat_advisor')}\nØ²Ù†Ú¯ Ø¯Ø¹ÙˆØª: ${getV('stat_invite')}\nÙ¾Ø±Ø²Ù†Øª: ${getV('stat_present')}\nØ§Ø±ØªØ¨Ø§Ø· Ù…ÙˆØ«Ø±: ${getV('stat_relation')}\nØ¢Ù…ÙˆØ²Ø´: ${getV('stat_edu')}\nØ«Ø¨Øª Ù†Ø§Ù…: ${getV('stat_reg')}\nØ§Ù…ØªÛŒØ§Ø² Ø®Ø±ÛŒØ¯: ${getV('stat_point')}`;
        if (navigator.share) navigator.share({ text: text });
        else { navigator.clipboard.writeText(text); alert("Ú©Ù¾ÛŒ Ø´Ø¯"); }
    }

    function clearAllDataForToday() {
        if(confirm("Ú©Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ùˆ Ø¢Ù…Ø§Ø± Ø§Ù…Ø±ÙˆØ² Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) {
            localStorage.removeItem('teamPlanner_' + currentKey);
            loadDataForDate(currentKey);
        }
    }
</script>

</body>
</html>
