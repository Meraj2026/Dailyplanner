<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>پنل مدیریت برنامه روزانه</title>
    <style>
        /* حفظ دقیق استایل‌های پایه فایل index 9 */
        :root { --primary-color: #2c3e50; --accent-color: #27ae60; --gray-bg: #e0e0e0; }
        body { font-family: Tahoma, Geneva, sans-serif; background-color: #fafafa; padding: 15px; font-size: 13px; direction: rtl; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border: 1px solid #ccc; }
        
        /* هدر - جلوگیری از به هم ریختگی در موبایل */
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #000; padding-bottom: 15px; flex-wrap: nowrap; overflow-x: auto; }
        .header-item { display: flex; align-items: center; gap: 5px; font-weight: bold; white-space: nowrap; margin-left: 10px; }
        .top-header input { border: none; border-bottom: 1px dotted #000; padding: 3px; width: 100px; outline: none; background: transparent; font-family: Tahoma; }

        /* جدول - فیکس کردن عرض برای جلوگیری از له شدن ستون‌ها */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; min-width: 800px; }
        th { background-color: #000; color: white; padding: 10px; border: 1px solid #444; font-weight: normal; }
        td { border: 1px solid #000; padding: 6px; text-align: center; height: 35px; word-wrap: break-word; }
        tr:nth-child(even) { background-color: var(--gray-bg); }
        
        .status-cell { cursor: pointer; font-size: 18px; user-select: none; width: 45px; }
        .status-check { color: #27ae60; font-weight: bold; }
        .status-cross { color: #e74c3c; font-weight: bold; }

        .actions { margin-bottom: 15px; display: flex; gap: 10px; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-family: Tahoma; font-weight: bold; }
        .btn-new { background-color: var(--accent-color); }
        .btn-clear { background-color: #e74c3c; }

        /* اصلاح نهایی کادر گزارش کار - عمودی، منظم و تراز */
        .summary-report { 
            margin-top: 30px; 
            padding: 15px; 
            border: 2px solid #333; 
            border-radius: 8px; 
            width: 220px; /* پهنای فیکس عمودی */
            background-color: #fff;
        }
        .summary-report h3 { margin: 0 0 15px 0; border-bottom: 1px solid #ccc; padding-bottom: 8px; font-size: 13px; text-align: center; white-space: nowrap; }
        
        .report-row { 
            display: flex; 
            align-items: center; 
            justify-content: flex-start; 
            margin-bottom: 8px; 
        }
        .report-label { 
            min-width: 90px; /* عرض ثابت برای تراز شدن دو نقطه‌ها */
            font-weight: bold; 
            display: flex;
            justify-content: space-between;
        }
        .report-label::after { content: ":"; margin-left: 5px; }
        
        .report-row input { 
            width: 60px; 
            padding: 4px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            text-align: center; 
            margin-right: auto; /* چسبیدن باکس به سمت چپ */
        }

        /* مدال */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-content { background: white; margin: 10% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }
        .form-group { margin-bottom: 10px; display: flex; flex-direction: column; }
        .form-group input, .form-group select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: Tahoma; }
        .disabled-field { background-color: #333 !important; color: #333 !important; }
    </style>
</head>
<body>

<div class="container" style="overflow-x: auto;">
    <div class="top-header">
        <div class="header-item">برنامه تیمی: <input type="text" id="ownerName" oninput="saveHeader()"></div>
        <div class="header-item">روز: <input type="text" id="dayName" oninput="updateSummary()"></div>
        <div class="header-item">مورخه: <input type="text" id="todayDate" oninput="updateSummary()"></div>
    </div>

    <div class="actions">
        <button class="btn btn-new" onclick="openModal()">+ ثبت برنامه جدید</button>
        <button class="btn btn-clear" onclick="clearData()">پاک کردن کل</button>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 40px;">ردیف</th>
                <th style="width: 50px;">نتیجه</th>
                <th>عنوان</th>
                <th>مخاطب</th>
                <th>معرف</th>
                <th style="width: 70px;">ساعت</th>
                <th>مکان</th>
                <th>برگزارکننده</th>
                <th>نفر چهارم</th>
                <th style="width: 60px;">اصلاح</th>
                <th style="width: 60px;">حذف</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div class="summary-report">
        <h3 id="summaryTitle">گزارش کار روزانه</h3>
        
        <div class="report-row">
            <span class="report-label">تعداد مشاور</span>
            <input type="number" inputmode="numeric" id="stat_advisor" oninput="saveStats()">
        </div>
        <div class="report-row">
            <span class="report-label">زنگ دعوت</span>
            <input type="number" inputmode="numeric" id="stat_invite" oninput="saveStats()">
        </div>
        <div class="report-row">
            <span class="report-label">پرزنت</span>
            <input type="number" inputmode="numeric" id="stat_present" oninput="saveStats()">
        </div>
        <div class="report-row">
            <span class="report-label">ارتباط مؤثر</span>
            <input type="number" inputmode="numeric" id="stat_relation" oninput="saveStats()">
        </div>
        <div class="report-row">
            <span class="report-label">آموزش</span>
            <input type="number" inputmode="numeric" id="stat_edu" oninput="saveStats()">
        </div>
        <div class="report-row">
            <span class="report-label">ثبت نام</span>
            <input type="number" inputmode="numeric" id="stat_reg" oninput="saveStats()">
        </div>
        <div class="report-row">
            <span class="report-label">امتیاز خرید</span>
            <input type="number" inputmode="numeric" id="stat_point" oninput="saveStats()">
        </div>
    </div>
</div>

<div id="planModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">ثبت برنامه</h3>
        <input type="hidden" id="editIndex" value="-1">
        <div class="form-group">
            <label>نوع:</label>
            <select id="planType" onchange="toggleFields()">
                <option value="work">برنامه کاری</option>
                <option value="personal">برنامه شخصی</option>
            </select>
        </div>
        <div class="form-group"><label>عنوان:</label><input type="text" id="title"></div>
        <div id="workFields">
            <div class="form-group"><label>مخاطب:</label><input type="text" id="audience"></div>
            <div class="form-group"><label>معرف:</label><input type="text" id="ref"></div>
            <div class="form-group"><label>مکان:</label><input type="text" id="location"></div>
            <div class="form-group"><label>برگزارکننده:</label><input type="text" id="organizer"></div>
            <div class="form-group"><label>نفر چهارم:</label><input type="text" id="fourthPerson"></div>
        </div>
        <div class="form-group"><label>ساعت:</label><input type="time" id="time"></div>
        <div style="display:flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
            <button class="btn" style="background:#95a5a6" onclick="closeModal()">انصراف</button>
            <button class="btn btn-new" onclick="saveEntry()">ذخیره</button>
        </div>
    </div>
</div>

<script>
    // جاوااسکریپت عینا مشابه نسخه index 9 برای حفظ پایداری
    let longPressTimer;
    const modal = document.getElementById("planModal");

    function updateSummary() {
        const d = document.getElementById('dayName').value || "";
        const t = document.getElementById('todayDate').value || "";
        document.getElementById('summaryTitle').innerText = `گزارش کار ${d} مورخه ${t}`;
        saveHeader();
    }

    function saveHeader() {
        const h = { owner: document.getElementById('ownerName').value, day: document.getElementById('dayName').value, date: document.getElementById('todayDate').value };
        localStorage.setItem('headerInfo', JSON.stringify(h));
    }

    function saveStats() {
        const s = { advisor: document.getElementById('stat_advisor').value, invite: document.getElementById('stat_invite').value, present: document.getElementById('stat_present').value, relation: document.getElementById('stat_relation').value, edu: document.getElementById('stat_edu').value, reg: document.getElementById('stat_reg').value, point: document.getElementById('stat_point').value };
        localStorage.setItem('dailyStats', JSON.stringify(s));
    }

    function renderTable() {
        const allData = JSON.parse(localStorage.getItem('dailyPlans')) || [];
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        allData.forEach((item, index) => {
            const isPers = item.type === 'personal';
            const bg = isPers ? 'background:#333;color:#333;' : '';
            let icon = item.status === 'check' ? '✔' : (item.status === 'cross' ? '✖' : '');
            let cls = item.status === 'check' ? 'status-check' : 'status-cross';
            tbody.innerHTML += `<tr><td>${index + 1}</td><td class="status-cell ${cls}" onclick="handleStatusClick(${index})" onmousedown="startLP(${index})" onmouseup="stopLP()" ontouchstart="startLP(${index})" ontouchend="stopLP()">${icon}</td><td>${item.title}</td><td style="${bg}">${item.audience}</td><td style="${bg}">${item.ref}</td><td>${item.time}</td><td style="${bg}">${item.location}</td><td style="${bg}">${item.organizer}</td><td style="${bg}">${item.fourthPerson}</td><td><button class="btn btn-edit" style="background:#f39c12;padding:4px;" onclick="openModal(${index})">اصلاح</button></td><td><button class="btn btn-delete" style="background:#e74c3c;padding:4px;" onclick="deleteRow(${index})">حذف</button></td></tr>`;
        });
    }

    function openModal(i = -1) {
        modal.style.display = "block";
        if(i > -1) {
            const d = JSON.parse(localStorage.getItem('dailyPlans'))[i];
            document.getElementById('editIndex').value = i;
            document.getElementById('planType').value = d.type;
            document.getElementById('title').value = d.title;
            document.getElementById('audience').value = d.audience;
            document.getElementById('ref').value = d.ref;
            document.getElementById('location').value = d.location;
            document.getElementById('organizer').value = d.organizer;
            document.getElementById('fourthPerson').value = d.fourthPerson;
            document.getElementById('time').value = d.time;
        } else { resetForm(); }
        toggleFields();
    }

    function closeModal() { modal.style.display = "none"; }
    function toggleFields() {
        const isP = document.getElementById('planType').value === 'personal';
        document.querySelectorAll('#workFields input').forEach(i => { i.value = isP ? "---" : (i.value==="---"?"":i.value); i.disabled = isP; isP ? i.classList.add('disabled-field') : i.classList.remove('disabled-field'); });
    }
    function saveEntry() {
        const idx = parseInt(document.getElementById('editIndex').value);
        const row = { title: document.getElementById('title').value, audience: document.getElementById('audience').value, ref: document.getElementById('ref').value, time: document.getElementById('time').value, location: document.getElementById('location').value, organizer: document.getElementById('organizer').value, fourthPerson: document.getElementById('fourthPerson').value, type: document.getElementById('planType').value, status: idx > -1 ? (JSON.parse(localStorage.getItem('dailyPlans'))[idx].status || "") : "" };
        if(!row.title || !row.time) return;
        let d = JSON.parse(localStorage.getItem('dailyPlans')) || [];
        if(idx > -1) d[idx] = row; else d.push(row);
        d.sort((a,b) => a.time.localeCompare(b.time));
        localStorage.setItem('dailyPlans', JSON.stringify(d));
        renderTable(); closeModal();
    }
    function deleteRow(i) { if(confirm("حذف؟")) { let d = JSON.parse(localStorage.getItem('dailyPlans')); d.splice(i,1); localStorage.setItem('dailyPlans', JSON.stringify(d)); renderTable(); } }
    function handleStatusClick(i) { if(longPressTimer !== null) updateStatus(i, 'check'); }
    function startLP(i) { longPressTimer = setTimeout(() => { updateStatus(i, 'cross'); longPressTimer = null; }, 600); }
    function stopLP() { clearTimeout(longPressTimer); }
    function updateStatus(i, t) { let d = JSON.parse(localStorage.getItem('dailyPlans')); d[i].status = (d[i].status === t) ? "" : t; localStorage.setItem('dailyPlans', JSON.stringify(d)); renderTable(); }
    function resetForm() { document.getElementById('editIndex').value = "-1"; document.querySelectorAll('.modal input').forEach(i => i.value = ""); document.getElementById('planType').value = "work"; }
    function clearData() { if(confirm("پاک کردن کل حافظه؟")) { localStorage.clear(); location.reload(); } }

    window.onload = () => {
        const h = JSON.parse(localStorage.getItem('headerInfo'));
        if(h) { document.getElementById('ownerName').value = h.owner || ""; document.getElementById('dayName').value = h.day || ""; document.getElementById('todayDate').value = h.date || ""; updateSummary(); }
        const s = JSON.parse(localStorage.getItem('dailyStats'));
        if(s) { document.getElementById('stat_advisor').value = s.advisor; document.getElementById('stat_invite').value = s.invite; document.getElementById('stat_present').value = s.present; document.getElementById('stat_relation').value = s.relation; document.getElementById('stat_edu').value = s.edu; document.getElementById('stat_reg').value = s.reg; document.getElementById('stat_point').value = s.point; }
        renderTable();
    };
</script>
</body>
</html>
